┌─────────────────────────────────────────────────────────────────────┐
│                       TuneTrace.AI v2.0                              │
│           Music Analysis & Recommendation System                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                         USER INPUT                                   │
│  • "Song Name by Artist"                                             │
│  • "https://youtube.com/watch?v=xyz"                                 │
│  • Multiple songs (newline or comma separated)                       │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    TuneTraceAgent (agent.py)                         │
│  ┌───────────────────────────────────────────────────────────────┐  │
│  │ 1. Parse Input                                                 │  │
│  │    ├─ Single song?                                             │  │
│  │    ├─ Multiple songs?                                          │  │
│  │    └─ URL?                                                     │  │
│  └───────────────────────────┬───────────────────────────────────┘  │
│                               │                                      │
│  ┌───────────────────────────▼───────────────────────────────────┐  │
│  │ 2. Agentic Loop (max 10 iterations)                           │  │
│  │    ┌────────────────────────────────────────────────────────┐ │  │
│  │    │ a) Generate Gemini Response                            │ │  │
│  │    │ b) Check for Tool Calls                                │ │  │
│  │    │ c) Execute Tools if needed                             │ │  │
│  │    │ d) Continue until final JSON output                    │ │  │
│  │    └────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────┬───────────────────────────────────┘  │
│                               │                                      │
│                               ▼                                      │
│           ┌──────────────────────────────────────┐                  │
│           │  System Instruction (prompt.py)      │                  │
│           │  • 20-Parameter Rubric               │                  │
│           │  • Analysis Guidelines               │                  │
│           │  • Output Format Rules               │                  │
│           └──────────────────────────────────────┘                  │
└─────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    TOOLS SYSTEM (tools.py)                           │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🔍 search_song_info(song_query)                                │ │
│  │    └─> Google Search for genre, tempo, mood, lyrics, etc.     │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🔗 fetch_song_from_url(url)                                    │ │
│  │    └─> Extract info from YouTube, Spotify, SoundCloud URLs    │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🎵 search_similar_songs(genre, mood, era, exclude_artist)     │ │
│  │    └─> Find matching songs for recommendations                │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🌐 Google Search Grounding                                     │ │
│  │    └─> Real-time internet access for current info             │ │
│  └────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│              20-PARAMETER ANALYSIS ENGINE                            │
│                                                                      │
│  ┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓  │
│  ┃ HIGH PRIORITY (Core Identity) - 4 parameters                  ┃  │
│  ┃ • Intangible Vibe     • Genre / Subgenre                      ┃  │
│  ┃ • Mood / Tone         • Tempo (BPM)                           ┃  │
│  ┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛  │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ MEDIUM PRIORITY (Musical Characteristics) - 6 parameters       │ │
│  │ • Vocal Style         • Lyrical Themes    • Instrumentation    │ │
│  │ • Timbre & Texture    • Rhythm / Groove   • Occasion/Activity  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ LOW PRIORITY (Technical & Context) - 9 parameters              │ │
│  │ • Song Structure      • Dynamic Range     • Harmonic Complex.  │ │
│  │ • Instr. Density      • Stereo Imaging    • Use of Effects     │ │
│  │ • Era / Decade        • Geographic Origin • Sampling           │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Each parameter includes:                                            │
│  └─> value: Specific annotation                                     │
│  └─> confidence_score: 0.0 (uncertain) to 1.0 (confident)          │
└─────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│              RECOMMENDATION ENGINE                                   │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🎯 Recommendation 1: DIRECT MATCH                              │ │
│  │    • Same/similar genre                                        │ │
│  │    • Matching mood/vibe                                        │ │
│  │    • Similar tempo                                             │ │
│  │    • Different artist                                          │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🎯 Recommendation 2: DIRECT MATCH                              │ │
│  │    • Complements first recommendation                          │ │
│  │    • Still within genre family                                 │ │
│  │    • Different artist                                          │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │ 🎲 Recommendation 3: WILDCARD                                  │ │
│  │    • MUST differ in 2+ HIGH categories                         │ │
│  │    • MUST share key vibe or mood                               │ │
│  │    • Enables cross-genre discovery                             │ │
│  │    • Different artist                                          │ │
│  │    Example: Hip-Hop → Trip-Hop (same dark mood, diff. genre)  │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Each recommendation includes:                                       │
│  └─> song_name, artist                                              │
│  └─> rationale (2-3 sentences referencing 2+ parameters)           │
└─────────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    JSON OUTPUT FORMATTER                             │
│  • Extract JSON from Gemini response                                 │
│  • Validate structure (3 keys: disclaimer, analysis, recs)          │
│  • Ensure all 20 parameters present                                  │
│  • Verify 3 recommendations with proper format                       │
└──────────────────────────┬──────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────────┐
│                   STRUCTURED JSON OUTPUT                             │
│                                                                      │
│  {                                                                   │
│    "disclaimer": "AI-generated analysis disclaimer",                 │
│    "input_song_analysis": {                                          │
│      "song_name": "Song Title",                                      │
│      "artist": "Artist Name",                                        │
│      "parameters": {                                                 │
│        "Intangible Vibe": {                                          │
│          "value": "Description",                                     │
│          "confidence_score": 0.95                                    │
│        },                                                            │
│        // ... 19 more parameters                                     │
│      }                                                               │
│    },                                                                │
│    "recommendations": [                                              │
│      {                                                               │
│        "song_name": "Match 1",                                       │
│        "artist": "Artist 1",                                         │
│        "rationale": "Why this matches (2+ params)"                   │
│      },                                                              │
│      { /* Match 2 */ },                                              │
│      {                                                               │
│        "song_name": "Wildcard",                                      │
│        "artist": "Artist 3",                                         │
│        "rationale": "[WILDCARD] Cross-genre match"                   │
│      }                                                               │
│    ]                                                                 │
│  }                                                                   │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                    TECHNOLOGY STACK                                  │
│  • Python 3.10+                                                      │
│  • Google Gemini 2.0 Flash (gemini-2.0-flash-exp)                   │
│  • Google Search Grounding API                                       │
│  • Function Calling / Tool Use                                       │
│  • google-genai library (≥0.2.0)                                     │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                    KEY FEATURES                                      │
│  ✅ Multi-format input (name, URL, multiple songs)                  │
│  ✅ Real-time internet access via Google Search                     │
│  ✅ Agentic self-directed tool usage                                │
│  ✅ Comprehensive 20-parameter analysis                             │
│  ✅ Confidence scoring for transparency                             │
│  ✅ Smart recommendations with wildcard                             │
│  ✅ Batch processing support                                        │
│  ✅ Graceful error handling                                         │
│  ✅ Structured JSON output                                          │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│                    TYPICAL WORKFLOW                                  │
│  1. User provides song input                                         │
│  2. Agent parses input and initiates agentic loop                    │
│  3. Agent autonomously:                                              │
│     • Searches for song information                                  │
│     • Extracts URL data if applicable                                │
│     • Analyzes across 20 parameters                                  │
│     • Searches for similar songs                                     │
│     • Generates 2 direct + 1 wildcard recommendations                │
│  4. Output formatted as structured JSON                              │
│  5. User receives complete analysis with confidence scores           │
│                                                                      │
│  ⏱️  Typical time: 5-15 seconds per song                            │
└─────────────────────────────────────────────────────────────────────┘



